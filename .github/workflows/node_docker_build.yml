name: "Catalyst Node - Docker build and push"

on:
  workflow_dispatch:
  push:
    branches: [master]
    tags:
      - "v*"
    paths:
      - "common/**"
      - "e2e_tests/**"
      - "pacaya/**"
      - "permissionless/**"
      - "node/**"
      - "shasta/**"
      - "urc/**"

env:
  DOCKER_PUBLIC_REGISTRY: docker.io
  DOCKER_PUBLIC_REPOSITORY: nethermind/catalyst-node
  DOCKER_REGISTRY: nethermind.jfrog.io
  DOCKER_REPOSITORY_STAGING: core-oci-local-staging/catalyst-node
  MASTER_BRANCH: refs/heads/master

jobs:
  build:
    name: Build per-arch image
    runs-on: ${{ matrix.os }}
    if: github.repository == 'NethermindEth/Catalyst'
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            platform: linux/amd64
            short: amd64
          - os: ubuntu-24.04-arm
            platform: linux/arm64
            short: arm64

    outputs:
      digest-amd64: ${{ steps.digest.outputs.amd64 }}
      digest-arm64: ${{ steps.digest.outputs.arm64 }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to JFrog Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_CORE_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_CORE_TOKEN_DEVELOPER }}

      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: Dockerfile
          platforms: ${{ matrix.platform }}
          push: true
          outputs: type=image,name=${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY_STAGING }},push-by-digest=true,name-canonical=true

      - name: Set digest output
        id: digest
        run: |
          echo "${{ matrix.short }}=${{ steps.build.outputs.digest }}" >> $GITHUB_OUTPUT

  merge:
    name: Merge and push multi-arch manifest
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Login to JFrog Artifactory
        uses: docker/login-action@v3
        with:
          registry: ${{ env.DOCKER_REGISTRY }}
          username: ${{ secrets.ARTIFACTORY_CORE_USERNAME }}
          password: ${{ secrets.ARTIFACTORY_CORE_TOKEN_DEVELOPER }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Calculate SHA tag
        id: sha
        run: |
          SHORT_SHA="${{ github.sha }}"
          SHORT_SHA=${SHORT_SHA:0:7}
          echo "tag=sha-${SHORT_SHA}" >> $GITHUB_OUTPUT
          echo "short=${SHORT_SHA}" >> $GITHUB_OUTPUT

      - name: Determine tags and event type
        id: tags
        run: |
          REF="${{ github.ref }}"
          IS_MASTER=false
          IS_TAG=false
          VERSION_TAG=""
          PROMOTE_TAGS=""

          if [[ "$REF" == refs/tags/* ]]; then
            IS_TAG=true
            VERSION_TAG=${REF#refs/tags/}
            PROMOTE_TAGS="$VERSION_TAG ${{ steps.sha.outputs.tag }}"
            echo "tag_list=type=raw,value=$VERSION_TAG" >> $GITHUB_OUTPUT
          elif [[ "$REF" == ${{ env.MASTER_BRANCH }} ]]; then
            IS_MASTER=true
            PROMOTE_TAGS="latest ${{ steps.sha.outputs.tag }}"
            echo "tag_list=type=raw,value=latest" >> $GITHUB_OUTPUT
          else
            PROMOTE_TAGS="${{ steps.sha.outputs.tag }}"
            echo "tag_list=type=sha,value=${{ github.sha }}" >> $GITHUB_OUTPUT
          fi

          echo "is_master=$IS_MASTER" >> $GITHUB_OUTPUT
          echo "is_tag=$IS_TAG" >> $GITHUB_OUTPUT
          echo "version_tag=$VERSION_TAG" >> $GITHUB_OUTPUT
          echo "promote_tags=$PROMOTE_TAGS" >> $GITHUB_OUTPUT
          echo "promote_tags=$PROMOTE_TAGS" >> $GITHUB_ENV

      - name: Generate Docker metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY_STAGING }}
          tags: ${{ steps.tags.outputs.tag_list }}

      - name: Create and push manifest list
        run: |
          # Filter out "latest" tag if not on master branch
          if [[ "${{ steps.tags.outputs.is_master }}" != "true" ]]; then
            FILTERED_TAGS=$(jq -cr '.tags | map(select(. | endswith(":latest") | not)) | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          else
            FILTERED_TAGS=$(jq -cr '.tags | map("-t " + .) | join(" ")' <<< "$DOCKER_METADATA_OUTPUT_JSON")
          fi

          if [ -n "$FILTERED_TAGS" ]; then
            docker buildx imagetools create \
              $FILTERED_TAGS \
              ${{ needs.build.outputs.digest-amd64 }} \
              ${{ needs.build.outputs.digest-arm64 }}
          fi

      - name: Tag with commit SHA
        run: |
          docker buildx imagetools create \
            -t ${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY_STAGING }}:${{ steps.sha.outputs.tag }} \
            ${{ needs.build.outputs.digest-amd64 }} \
            ${{ needs.build.outputs.digest-arm64 }}

      - name: Setup ORAS
        uses: oras-project/setup-oras@v1

      - name: Login to Docker Hub
        run: |
          oras login ${{ env.DOCKER_PUBLIC_REGISTRY }} \
            -u ${{ secrets.DOCKER_USERNAME }} \
            -p ${{ secrets.DOCKER_PASSWORD }}

      - name: Promote to Docker Hub Production
        run: |
          set -e
          for tag in $PROMOTE_TAGS; do
            source_image="${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY_STAGING }}:${tag}"
            prod_image="${{ env.DOCKER_PUBLIC_REGISTRY }}/${{ env.DOCKER_PUBLIC_REPOSITORY }}:${tag}"
            echo "Promoting ${source_image} to ${prod_image}"
            oras cp -r "${source_image}" "${prod_image}"
          done

      - name: Summary
        run: |
          echo "## Catalyst Node Docker build Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tags Promoted" >> $GITHUB_STEP_SUMMARY
          
          # Get tags from step output (more reliable than env var)
          TAGS_STRING="${{ steps.tags.outputs.promote_tags }}"
          
          # If step output is empty, try environment variable
          if [ -z "$TAGS_STRING" ]; then
            TAGS_STRING="$PROMOTE_TAGS"
          fi
          
          # Split tags by space and display each one
          if [ -n "$TAGS_STRING" ]; then
            # Convert space-separated string to array and iterate
            for tag in $TAGS_STRING; do
              echo "- \`${tag}\`" >> $GITHUB_STEP_SUMMARY
            done
          else
            echo "- No tags available" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Repository Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Staging**: \`${{ env.DOCKER_REGISTRY }}/${{ env.DOCKER_REPOSITORY_STAGING }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Production**: \`${{ env.DOCKER_PUBLIC_REGISTRY }}/${{ env.DOCKER_PUBLIC_REPOSITORY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Platforms**: linux/amd64, linux/arm64" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit**: \`${{ github.sha }}\` (\`${{ steps.sha.outputs.short }}\`)" >> $GITHUB_STEP_SUMMARY
